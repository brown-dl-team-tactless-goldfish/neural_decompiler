class Solution {
public:
    vector<int> longestObstacleCourseAtEachPosition(vector<int>& nums)
	{
		vector<int> lis(nums.size(), 1);
		vector<int> minObstacle(nums.size() + 1, nums.size());
		minObstacle[1] = nums[0];
		int max_len = 1;

		for (int i = 1; i < nums.size(); i++) {
			if (nums[i] >= minObstacle[max_len]) {
				lis[i] = ++max_len;
				minObstacle[max_len] = nums[i];
				continue;
			}

			int l = 1, r = max_len + 1, m;
			while (l < r) {
				m = l + (r - l) / 2;
				if (minObstacle[m] <= nums[i]) {
					l = m + 1;
				}
				else {
					r = m;
				}
			}

			lis[i] = m == 1 ? m + (nums[i] >= minObstacle[m]) : min(r, m + 1);
			minObstacle[lis[i]] = min(nums[i], minObstacle[lis[i]]);
		}

		return lis;
	}
};