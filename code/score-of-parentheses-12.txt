public int ScoreOfParentheses(string S) {
	var stack = new Stack<int>();

	foreach (var c in S.ToCharArray()) {
		if (c == '(') stack.Push(0);
		else {
			var list = new List<int>();
			do {
				var pop = stack.Pop();
				if (pop == 0) {
					stack.Push(list.Any() ? 2 * list.Sum() : 1);
					break;
				}
				list.Add(pop);
			} while (stack.Count > 0);
		}
	}

	return stack.Sum();
}