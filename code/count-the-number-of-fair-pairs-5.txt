public class Solution 
{
    public long CountFairPairs(int[] nums, int lower, int upper) 
    {
        Array.Sort(nums);
        int n = nums.Length;
        long result = 0;
        int left = n;
        int right = n;
        for (int i = 0; i < n; i++)
        {
            left = Math.Max(left, i+1);
            while (left-1 > i && nums[i] + nums[left-1] >= lower)
            {
                left--;
            }
            while (right-1 > i && nums[i] + nums[right-1] > upper)
            {
                right--;
            }
            if (left > right)
                break;
            result += right - left;
        }
        return result;
    }
}