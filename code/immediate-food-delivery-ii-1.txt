with h as 
(
with c as 
(
with b as 
(
    with a
as
(
#with a
#as
#(
    # Write your MySQL query statement below
    select  customer_id,delivery_id , min(order_date) over(partition by customer_id,order_date)  AS order_date
    , customer_pref_delivery_date 
    from delivery 
    #group by  customer_id
   # having count(order_date) = 1 
#)
#select delivery_id , order_date  from a 
#group by customer_id 

)
select delivery_id, customer_id , customer_pref_delivery_date ,order_date,dense_rank() over(partition by customer_id order by order_date asc) as rnk from a 
)
select delivery_id , customer_pref_delivery_date ,order_date   from b 
where rnk = 1 
group by customer_id
having count(order_date) = 1 

 
)
select  count(delivery_id) / (select count(delivery_id)  from 
(
with c as 
(
with b as 
(
    with a
as
(
#with a
#as
#(
    # Write your MySQL query statement below
    select  customer_id,delivery_id , min(order_date) over(partition by customer_id,order_date)  AS order_date
    , customer_pref_delivery_date 
    from delivery 
    #group by  customer_id
   # having count(order_date) = 1 
#)
#select delivery_id , order_date  from a 
#group by customer_id 

)
select delivery_id, customer_id , customer_pref_delivery_date ,order_date,dense_rank() over(partition by customer_id order by order_date asc) as rnk from a 
)
select delivery_id , customer_pref_delivery_date ,order_date   from b 
where rnk = 1 
group by customer_id
having count(order_date) = 1 

 
)
select  delivery_id  from c 
#where customer_pref_delivery_date = order_date 
) jey1) as n  from c 
where customer_pref_delivery_date = order_date  

)
select round(n*100, 2 )  AS immediate_percentage from h 